# ===========================================================
# AEDRON | Ops Stability Analytics - Makefile
# ===========================================================
# DescripciÃ³n:
# Automatiza la ejecuciÃ³n local del pipeline Fabric-ready:
# 1. Configura entorno virtual
# 2. Ejecuta scripts de ETL y KPI
# 3. Corre pruebas unitarias
# 4. Permite limpiar o desactivar entorno
# ===========================================================

PYTHON := python
VENV := .venv
ACTIVATE := source $(VENV)/bin/activate

# ----------------------------------------
#  InicializaciÃ³n del entorno virtual
# ----------------------------------------
init:
	@echo "ðŸ§± Creando entorno virtual..."
	$(PYTHON) -m venv $(VENV)
	@$(ACTIVATE) && pip install --upgrade pip && pip install -r requirements.txt
	@echo "âœ… Entorno listo."

# ----------------------------------------
#  EjecuciÃ³n del pipeline (ETL + KPIs)
# ----------------------------------------
run:
	@echo "ðŸš€ Ejecutando pipeline completo..."
	@$(ACTIVATE) && \
	$(PYTHON) src/etl/generate_synthetic_data.py && \
	$(PYTHON) src/analytics/kpi_calculations.py && \
	pytest -q --tb=short --disable-warnings
	@echo "âœ… Pipeline completado con Ã©xito."

# ----------------------------------------
#  Pruebas unitarias
# ----------------------------------------
test:
	@echo "ðŸ§ª Ejecutando pruebas unitarias..."
	@$(ACTIVATE) && pytest -q --tb=short --disable-warnings

# ----------------------------------------
#  Limpieza (archivos temporales y datos)
# ----------------------------------------
clean:
	@echo "ðŸ§¹ Limpiando artefactos..."
	rm -rf __pycache__ .pytest_cache
	rm -rf lakehouse_sim/Files/raw/*.parquet
	rm -rf lakehouse_sim/Tables/*.parquet
	@echo "âœ… Limpieza completada."

# ----------------------------------------
#  Desactivar entorno virtual
# ----------------------------------------
deactivate:
	@echo "ðŸ”’ Desactivando entorno virtual..."
	deactivate || true
	@echo "âœ… Entorno desactivado."

# ----------------------------------------
#  Ayuda
# ----------------------------------------
help:
	@echo ""
	@echo "Comandos disponibles:"
	@echo "  make init         â†’ Crear e inicializar entorno virtual"
	@echo "  make run          â†’ Ejecutar pipeline completo"
	@echo "  make test         â†’ Ejecutar pruebas unitarias"
	@echo "  make clean        â†’ Limpiar artefactos temporales"
	@echo "  make deactivate   â†’ Desactivar entorno virtual"
	@echo ""
	