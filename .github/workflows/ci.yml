name: CI ‚Ä¢ Tests + E2E Validation

on:
  push:
    branches: [ main, develop, feature/** ]
  pull_request:

permissions:
  contents: read

jobs:
  fabric-tests:
    name: üß™ Fabric Mock ‚Ä¢ Unit tests + Notebooks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: projects/ops-stability-analytics-fabric-mock
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install deps (fabric)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # Necesarios para ejecutar notebooks en CI
          pip install jupyter nbconvert nbclient ipykernel

      - name: Run pytest (fabric)
        run: pytest -q --tb=short --disable-warnings

      - name: Execute notebooks (fabric)
        run: |
          jupyter nbconvert --to notebook --execute 01_Generate_Synthetic_Data.ipynb --inplace
          jupyter nbconvert --to notebook --execute 02_Calculate_KPIs.ipynb --inplace

  sql-e2e:
    name: üß± SQL ‚Ä¢ Full E2E pipeline
    runs-on: ubuntu-latest
    needs: fabric-tests
    defaults:
      run:
        working-directory: projects/ops-stability-analytics-sql
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install deps (SQL)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Launch DB containers
        run: docker compose up -d

      - name: Wait for Postgres healthy
        run: |
          for i in {1..30}; do
            docker exec ops_db pg_isready -U ops_user -d ops_analytics && break
            sleep 2
          done

      - name: Run E2E SQL pipeline
        # usa el Makefile del subproyecto
        working-directory: projects/ops-stability-analytics-sql
        env:
          ENV_FILE: .env.local
        run: make e2e-sql

      - name: Cleanup
        if: always()
        run: docker compose down -v

  conventional:
    name: üîé Conventional Commits
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Validate commit format
        run: |
          base="${{ github.base_ref }}"
          head="${{ github.head_ref }}"
          range="origin/$base..HEAD"
          if git log --no-merges --pretty=%s $range | grep -Ev '^(feat|fix|chore|refactor|perf|test|docs?|build|ci)(\(.+\))?: .+' >/dev/null; then
            echo "‚ùå Some commits don't match Conventional Commits."
            exit 1
          else
            echo "‚úÖ Conventional commits OK"
          fi